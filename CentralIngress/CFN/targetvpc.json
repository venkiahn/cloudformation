{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "This AWS CloudFormation template will create a perimeter ingress VPC with supporting resources for a Privatelink attached application VPCs",
    "Parameters": {
        "EnvName": {
            "Description": "(REQUIRED) Enter Environment Type (Dev/QA/Prod)",
            "Default": "Dev",
            "Type": "String",
            "AllowedValues": [
                "Dev",
                "QA",
                "Test",
                "Prod"
            ]
        },
        "Project": {
            "Type": "String",
            "Default": "Cohort2",
            "Description": "(REQUIRED) Enter the Project Name"
        },
        "VPCCIDRBLOCK": {
            "Default": "10.128.0.0/24",
            "Type": "String"
        }
    },
    "Mappings": {
        "ResourceTags": {
            "all": {
                "BudgetCentre": "DevOpsAoD",
                "AppName": "IngressPatternArtifact",
                "AppId": "Ingress001",
                "Department": "DevOps AoD",
                "Environment": "nonprod",
                "Role": "Public Facing Application Infrastructure",
                "SupportContract": "Plus",
                "Tier": "Infrastructure",
                "OwnerTeam": "AWS ProServe",
                "OwnerTeamEmail": "venkiahn@amazon.com",
                "Owner": "Nolan Venkiah"
            },
            "EC2": {
                "HoursOfOperation": "Mon-Fri_8-17",
                "DataClassification": "Confidential",
                "ComplianceFramework": "NIST",
                "Qualys": "Yes"
            }
        }
    },
    "Outputs": {
        "VPCId": {
            "Description": "The VPC Id",
            "Value": {"Ref": "TargetVPC"}
        },
        "VPCEpSvc": {
            "Description": "ENIs of the VPC Endpoints",
            "Value": {"Ref":"VPCEpSvc"},
            "Export": {
                "Name": "VpcEndpointSvc"
            }
        },
        "PvtSubnet1": {
            "Description": "Id of Subnet 1",
            "Value": {"Ref": "PvtSubnet1"}
        },
        "PvtSubnet2": {
            "Description": "Id of Subnet 2",
            "Value": {"Ref": "PvtSubnet2"}
        },
        "TargetSG": {
            "Description": "Id of the ingress security group",
            "Value": {"Ref": "TargetSG"}
        }
    },
    "Resources": {
        "TargetVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": {"Ref": "VPCCIDRBLOCK"},
                "EnableDnsHostnames": true,
                "EnableDnsSupport": true,
                "InstanceTenancy": "default",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "Project"
                                    },
                                    {
                                        "Ref": "EnvName"
                                    },
                                    "Ingress",
                                    "001"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "BudgetCentre",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "BudgetCentre"
                            ]
                        }
                    },
                    {
                        "Key": "AppName",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppName"
                            ]
                        }
                    },
                    {
                        "Key": "AppId",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppId"
                            ]
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Department"
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "SupportContract",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "SupportContract"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeam",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeam"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeamEmail",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeamEmail"
                            ]
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Owner"
                            ]
                        }
                    },
                    {
                        "Key": "HoursOfOperation",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "HoursOfOperation"
                            ]
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "DataClassification"
                            ]
                        }
                    },
                    {
                        "Key": "Qualys",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "Qualys"
                            ]
                        }
                    }
                ]
            }
        },
        "PvtSubnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "CidrBlock": "10.128.0.0/26",
                "VpcId": {
                    "Ref": "TargetVPC"
                },
                "AvailabilityZone": {
                    "Fn::Select": [
                    0,
                    {
                        "Fn::GetAZs": ""
                    }
                    ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                {
                    "Key": "Name",
                    "Value": {
                        "Fn::Join": [
                            "-",
                            [
                                {
                                    "Ref": "Project"
                                },
                                {
                                    "Ref": "EnvName"
                                },
                                "Subnet",
                                "001"
                            ]
                        ]
                    }
                },
                {
                    "Key": "BudgetCentre",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "BudgetCentre"
                        ]
                    }
                },
                {
                    "Key": "AppName",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "AppName"
                        ]
                    }
                },
                {
                    "Key": "AppId",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "AppId"
                        ]
                    }
                },
                {
                    "Key": "Department",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "Department"
                        ]
                    }
                },
                {
                    "Key": "Environment",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "Environment"
                        ]
                    }
                },
                {
                    "Key": "SupportContract",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "SupportContract"
                        ]
                    }
                },
                {
                    "Key": "OwnerTeam",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "OwnerTeam"
                        ]
                    }
                },
                {
                    "Key": "OwnerTeamEmail",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "OwnerTeamEmail"
                        ]
                    }
                },
                {
                    "Key": "Owner",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "all",
                            "Owner"
                        ]
                    }
                },
                {
                    "Key": "HoursOfOperation",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "EC2",
                            "HoursOfOperation"
                        ]
                    }
                },
                {
                    "Key": "DataClassification",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "EC2",
                            "DataClassification"
                        ]
                    }
                },
                {
                    "Key": "Qualys",
                    "Value": {
                        "Fn::FindInMap": [
                            "ResourceTags",
                            "EC2",
                            "Qualys"
                        ]
                    }
                }
                ]
            }
        },
        "PvtSubnet1RouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                "Ref": "TargetVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "Project"
                                    },
                                    {
                                        "Ref": "EnvName"
                                    },
                                    "TargetVpcRT",
                                    "001"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "BudgetCentre",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "BudgetCentre"
                            ]
                        }
                    },
                    {
                        "Key": "AppName",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppName"
                            ]
                        }
                    },
                    {
                        "Key": "AppId",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppId"
                            ]
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Department"
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "SupportContract",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "SupportContract"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeam",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeam"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeamEmail",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeamEmail"
                            ]
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Owner"
                            ]
                        }
                    },
                    {
                        "Key": "HoursOfOperation",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "HoursOfOperation"
                            ]
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "DataClassification"
                            ]
                        }
                    },
                    {
                        "Key": "Qualys",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "Qualys"
                            ]
                        }
                    }
                ]
            }
        },
        "PvtSubnet1RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                "Ref": "PvtSubnet1RouteTable"
                },
                "SubnetId": {
                "Ref": "PvtSubnet1"
                }
            }
        },
        "PvtSubnet1DefaultRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                "Ref": "PvtSubnet1RouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                "Ref": "NAT1"
                }
            },
            "DependsOn": "VPCGWAttach"
        },
        "PvtSubnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "CidrBlock": "10.128.0.64/26",
                "VpcId": {
                "Ref": "TargetVPC"
                },
                "AvailabilityZone": {
                "Fn::Select": [
                    1,
                    {
                    "Fn::GetAZs": ""
                    }
                ]
                },
                "MapPublicIpOnLaunch": true,
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "Project"
                                    },
                                    {
                                        "Ref": "EnvName"
                                    },
                                    "Subnet",
                                    "002"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "BudgetCentre",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "BudgetCentre"
                            ]
                        }
                    },
                    {
                        "Key": "AppName",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppName"
                            ]
                        }
                    },
                    {
                        "Key": "AppId",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppId"
                            ]
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Department"
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "SupportContract",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "SupportContract"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeam",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeam"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeamEmail",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeamEmail"
                            ]
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Owner"
                            ]
                        }
                    },
                    {
                        "Key": "HoursOfOperation",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "HoursOfOperation"
                            ]
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "DataClassification"
                            ]
                        }
                    },
                    {
                        "Key": "Qualys",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "Qualys"
                            ]
                        }
                    }
                ]
            }
        },
        "PvtSubnet2RouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                "Ref": "TargetVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "Project"
                                    },
                                    {
                                        "Ref": "EnvName"
                                    },
                                    "TargetVpcRT",
                                    "002"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "BudgetCentre",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "BudgetCentre"
                            ]
                        }
                    },
                    {
                        "Key": "AppName",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppName"
                            ]
                        }
                    },
                    {
                        "Key": "AppId",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppId"
                            ]
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Department"
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "SupportContract",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "SupportContract"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeam",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeam"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeamEmail",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeamEmail"
                            ]
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Owner"
                            ]
                        }
                    },
                    {
                        "Key": "HoursOfOperation",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "HoursOfOperation"
                            ]
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "DataClassification"
                            ]
                        }
                    },
                    {
                        "Key": "Qualys",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "Qualys"
                            ]
                        }
                    }
                ]
            },
            "DependsOn": "VPCGWAttach"
        },
        "PvtSubnet2RouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                "Ref": "PvtSubnet2RouteTable"
                },
                "SubnetId": {
                "Ref": "PvtSubnet2"
                }
            }
        },
        "PvtsSubnet2DefaultRoute": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                "Ref": "PvtSubnet2RouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "NatGatewayId": {
                "Ref": "NAT2"
                }
            },
            "DependsOn": "VPCGWAttach"
        },
        "InternetGateway" : {
            "Type" : "AWS::EC2::InternetGateway",
            "Properties" : {
                "Tags": [
                    {"Key": "stack", "Value": {"Ref":"EnvName"}}
                ]
            }
        },
        "VPCGWAttach" : {
            "Type" : "AWS::EC2::VPCGatewayAttachment",
            "Properties" : {
               "VpcId" : { "Ref" : "TargetVPC" },
               "InternetGatewayId" : { "Ref" : "InternetGateway" }
             }
        },
        "NAT1": {
            "DependsOn": "VPCGWAttach",
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "Tags": [
                {
                    "Key": "Name",
                    "Value": "NATGW1"
                }
                ],
                "SubnetId": {"Ref":"PvtSubnet1"},
                "AllocationId" : { "Fn::GetAtt" : ["EIP1", "AllocationId"]}
            }
        },
        "NAT2": {
            "DependsOn": "VPCGWAttach",
            "Type": "AWS::EC2::NatGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "NATGW2"
                    }
                ],
                "SubnetId": {"Ref":"PvtSubnet2"},
                "AllocationId" : { "Fn::GetAtt" : ["EIP2", "AllocationId"]}
            }
        },
        "EIP1" : {
            "DependsOn": "VPCGWAttach",
            "Type" : "AWS::EC2::EIP",
            "Properties" : {
               "Domain" : "vpc"
            }
        },
        "EIP2" : {
            "DependsOn": "VPCGWAttach",
            "Type" : "AWS::EC2::EIP",
            "Properties" : {
               "Domain" : "vpc"
            }
        },
        "TargetSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Allow inbound port 80 and 443",
                "GroupName": "TargetSG",
                "SecurityGroupEgress": [
                    {
                    "CidrIp": "0.0.0.0/0",
                    "Description": "Allow all outbound traffic by default",
                    "IpProtocol": "-1"
                    }
                ],
                "SecurityGroupIngress": [
                    {
                    "CidrIp": "0.0.0.0/0",
                    "Description": "HTTP from anywhere",
                    "FromPort": 80,
                    "IpProtocol": "tcp",
                    "ToPort": 80
                    },
                    {
                    "CidrIp": "0.0.0.0/0",
                    "Description": "HTTPS from anywhere",
                    "FromPort": 443,
                    "IpProtocol": "tcp",
                    "ToPort": 443
                    },
                    {
                    "CidrIp": {
                        "Fn::GetAtt": [
                        "TargetVPC",
                        "CidrBlock"
                        ]
                    },
                    "Description": {
                        "Fn::Join": [
                        "",
                        [
                            "from ",
                            {
                            "Fn::GetAtt": [
                                "TargetVPC",
                                "CidrBlock"
                            ]
                            },
                            ":80"
                        ]
                        ]
                    },
                    "FromPort": 80,
                    "IpProtocol": "tcp",
                    "ToPort": 80
                    }
                ],
                "VpcId": {
                    "Ref": "TargetVPC"
                }
            }
        },
        "NetworkLoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "Name": "target-pvtlink-nlb",
                "LoadBalancerAttributes" : [
                    {
                    "Key" : "load_balancing.cross_zone.enabled",
                    "Value" : "true"
                    }
                ],
                "Tags": [
                    {
                        "Key": "name",
                        "Value": {
                            "Fn::Join": [
                                "-",
                                [
                                    {
                                        "Ref": "Project"
                                    },
                                    {
                                        "Ref": "EnvName"
                                    },
                                    "TargetVpcNLB",
                                    "001"
                                ]
                            ]
                        }
                    },
                    {
                        "Key": "BudgetCentre",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "BudgetCentre"
                            ]
                        }
                    },
                    {
                        "Key": "AppName",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppName"
                            ]
                        }
                    },
                    {
                        "Key": "AppId",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "AppId"
                            ]
                        }
                    },
                    {
                        "Key": "Department",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Department"
                            ]
                        }
                    },
                    {
                        "Key": "Environment",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Environment"
                            ]
                        }
                    },
                    {
                        "Key": "SupportContract",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "SupportContract"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeam",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeam"
                            ]
                        }
                    },
                    {
                        "Key": "OwnerTeamEmail",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "OwnerTeamEmail"
                            ]
                        }
                    },
                    {
                        "Key": "Owner",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "all",
                                "Owner"
                            ]
                        }
                    },
                    {
                        "Key": "HoursOfOperation",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "HoursOfOperation"
                            ]
                        }
                    },
                    {
                        "Key": "DataClassification",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "DataClassification"
                            ]
                        }
                    },
                    {
                        "Key": "Qualys",
                        "Value": {
                            "Fn::FindInMap": [
                                "ResourceTags",
                                "EC2",
                                "Qualys"
                            ]
                        }
                    }
                ],
                "Subnets": [
                    {
                        "Ref": "PvtSubnet1"
                    },
                    {
                        "Ref": "PvtSubnet2"
                    }
                ],
                "Scheme": "internal",
                "Type": "network"
            }
        },
        "NLBListener1": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "Type": "forward",
                        "TargetGroupArn": {
                            "Ref": "NLBTargetGroup1"
                        }
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "NetworkLoadBalancer"
                },
                "Port": 80,
                "Protocol": "TCP"
            }
        },
        "NLBTargetGroup1": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "Port": 80,
                "Protocol": "TCP",
                "TargetType": "instance",
                "VpcId": {
                    "Ref": "TargetVPC"
                },
                "TargetGroupAttributes": [
                    {
                        "Key": "deregistration_delay.timeout_seconds",
                        "Value": "20"
                    }
                ]
            }
        },
        "VPCEpSvc":{
            "Type" : "AWS::EC2::VPCEndpointService",
            "Properties" : {
                "AcceptanceRequired" : false,
                "NetworkLoadBalancerArns" : [{"Ref": "NetworkLoadBalancer"}]
            }
        }
    }
}